<!DOCTYPE html><html lang="en" itemscope itemtype="https://schema.org/Blog"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Working with JavaScript promises: handling the unexpected</title><meta name="keywords" content="nodejs, workflow, javascript, promises, errors"><meta name="author" itemprop="creator" content="Adrian Oprea"><meta name="description" itemprop="description" content="Having worked with JavaScript Promises extensively in the past year, I often found myself in situations where handling output and errors was very hard to perform, from a semantic standpoint. I plan on sharing my experience with promises, especially error-handling, but this is by no mean something that should be taken as a best practice, it is only my take on this issue, and you are encouraged to share your experience and practices. "><meta property="og:type" content="article" /><meta property="og:title" content="Working with JavaScript promises: handling the unexpected" /><meta property="og:description" content="Having worked with JavaScript Promises extensively in the past year, I often found myself in situations where handling output and errors was very hard to perform, from a semantic standpoint. I plan on sharing my experience with promises, especially error-handling, but this is by no mean something that should be taken as a best practice, it is only my take on this issue, and you are encouraged to share your experience and practices. " /><meta property="og:image" content="https://codesi.nz/images/posts/error_handling_missile.jpg" /><meta property="og:url" content="https://codesi.nz/working-with-javascript-promises-handling-the-unexpected/" /><meta property="og:locale" content="en_US" /><meta property="article:published_time" content="2015-02-28T18:00:00+02:00" /><meta property="article:modified_time" content="2015-02-28T18:00:00+02:00 " /><link rel="canonical" href="https://codesi.nz/working-with-javascript-promises-handling-the-unexpected/"><meta name="”twitter:creator”" value=""><meta name="twitter:card" content="summary_large_image"><meta name="twitter:url" content="https://codesi.nz/working-with-javascript-promises-handling-the-unexpected/"><meta name="twitter:title" content="Working with JavaScript promises: handling the unexpected"><meta name="twitter:description" content="Having worked with JavaScript Promises extensively in the past year, I often found myself in situations where handling output and errors was very hard to perform, from a semantic standpoint. I plan on sharing my experience with promises, especially error-handling, but this is by no mean something that should be taken as a best practice, it is only my take on this issue, and you are encouraged to share your experience and practices. "><meta name="twitter:image" content="https://codesi.nz/images/posts/error_handling_missile.jpg"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="codesins. - The blog of Adrian Oprea, freelance web developer."><link rel="author" href="https://plus.google.com/+AdrianOpreasWeb/"><link rel="publisher" href="https://plus.google.com/+AdrianOpreasWeb/"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/normalize/4.0.0/normalize.min.css"><link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,300italic,700,400italic,600,600italic,700italic,800,800italic' rel='stylesheet' type='text/css'><link href='https://fonts.googleapis.com/css?family=Lato:100,300,900' rel='stylesheet' type='text/css'><link rel="stylesheet" href="/stylesheets/screen.css"><link rel="stylesheet" href="/stylesheets/prism.css"> <script> var host = "codesi.nz"; if ((host == window.location.host) && (window.location.protocol != "https:")) { window.location.protocol = "https"; } </script><body><div class="header"><div role="branding" class="branding"><h1><a href="/" title="Go back to the homepage">codesins.</a></h1></div><div class="navigation"><nav role="navigation"><ul><li class="active" ><a title="Navigate to the blog" href="/">Blog</a><li ><a title="Find out more about me" href="/about/">Who am I</a><li ><a title="Go to the contact page" href="/contact/">Let's chat</a></ul></nav></div></div><article class="article-full" itemprop="blogPosts" itemscope itemtype="https://schema.org/BlogPosting"><meta itemprop="datePublished" content="2015-02-28T18:00:00+02:00"><meta itemprop="dateModified" content="2015-02-28T18:00:00+02:00"><meta itemprop="keywords" content="nodejs, workflow, javascript, promises, errors"><meta itemprop="author" content="Adrian Oprea"><meta itemprop="inLanguage" content="en_US"> <span itemprop="audience" itemscope itemtype="http://schema.org/PeopleAudience"><meta itemprop="gender" content="any"> </span><header class="article-header"><h1 class="article-header__heading article-header__heading--center article-header__heading--white" itemprop="headline">Working with JavaScript promises: handling the unexpected</h1><div class="article-info article-info--delimited"><div class="article-info-inner"> <a class="article-info__author-profile" href="/about" title="About the author: Adrian Oprea"> <img class="article-info__author-image" src="/images/assets/adrian_oprea.png" alt="Author image: Adrian Oprea"> </a><p> Adrian Oprea on <time itemProp="datePublished" datetime="2015-02-28T18:00:00+02:00">28 Feb 2015</time><br> Published in <span class="categories-list"> <span class="categories-list-item">nodejs</span> </span></div></div></header><main class="article-body" itemprop="articleBody"><p>Having worked with <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">JavaScript Promises</a> extensively in the past year, I often found myself in situations where handling output and errors was very hard to perform, from a semantic standpoint.<br /> I plan on sharing my experience with promises, especially error-handling, but this is by no mean something that should be taken as a best practice, it is only my take on this issue, and you are encouraged to share your experience and practices.<h2 class="no_toc" id="table-of-contents">Table of contents</h2><ul id="markdown-toc"><li><a href="#whats-an-errorhttpenwikipediaorgwikierror" id="markdown-toc-whats-an-errorhttpenwikipediaorgwikierror">What’s an <a href="http://en.wikipedia.org/wiki/Error">Error</a></a><li><a href="#a-pattern-for-handling-the-unexpected-and-the-uncaught" id="markdown-toc-a-pattern-for-handling-the-unexpected-and-the-uncaught">A pattern for handling the <code class="highlighter-rouge">unexpected</code> and the <code class="highlighter-rouge">uncaught</code></a><li><a href="#conclusions" id="markdown-toc-conclusions">Conclusions</a></ul><h2 id="whats-an-errorhttpenwikipediaorgwikierror">What’s an <a href="http://en.wikipedia.org/wiki/Error">Error</a></h2><blockquote><p>The concrete meaning of the Latin word “error” is “wandering” or “straying”. […] an error or a mistake can sometimes be dispelled through knowledge.</blockquote><p>So basically an error can be interpreted as a state that can(sometimes, of course) be resolved/repaired by applying corrective action. This is exactly how I feel about JavaScript promises and what error-handling means when working with such a concept.<br /> In my opinion, there are situations or states that involve for example killing the process, and there are other situations that only involve setting some default data if no proper response is given. These cases are to be treated in a different way, as they involve different application states.<h2 id="a-pattern-for-handling-the-unexpected-and-the-uncaught">A pattern for handling the <code class="highlighter-rouge">unexpected</code> and the <code class="highlighter-rouge">uncaught</code></h2><p>Let’s say for example that we have to implement a method that performs an async call to a REST service and returns the data to be used in the UI. The implementation would probably look as follows:<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'request'</span><span class="p">),</span>
    <span class="nx">config</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'config'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">Customer</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">getData</span> <span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
        
        <span class="nx">request</span><span class="p">({</span>
            <span class="na">method</span>  <span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span>
            <span class="na">uri</span> <span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">uri</span>
        <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">));</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">};</span></code></pre></figure><p>You would be tempted to structure your code like the above snippet, and look for an error, and if no error is provided, then you can just resolve with the body, as nothing could have gone wrong.<br /> I say no to that approach, because you can bump into situations where you don’t get an <code class="highlighter-rouge">Error</code> object, but you do get a <code class="highlighter-rouge">500 Internal Server Error</code>.<p>Even though many of the NodeJS development best practices articles, and even the NodeJS documentation itself suggests that you should have an error-first approach when working with callbacks, in situations like the one above, it’s best to check for the status code and the presence of data, and forward the data to whoever is calling the method. If that’s not the case, reject the promise with MEANINGFUL INFORMATION.<br /> I’m stressing the “meaningful information” part so much because I’m a firm believer in these words: “Do unto others as you would have them do unto you”. This doesn’t mean in any way that I’m a religious type of person, not that it would be a shame, but I strongly believe in the power of setting examples, so if enough people are going to be able to quickly debug and track down possible issues because I added enough error-related information, they’ll soon follow that example — and I would love to see the same amout of details when I’m debugging someone else’s code.<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// [core/customer.js]</span>
<span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'request'</span><span class="p">),</span>
    <span class="nx">config</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'config'</span><span class="p">);</span>


<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">getData</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">customerId</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

        <span class="nx">request</span><span class="p">({</span>
            <span class="na">method</span>  <span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span>
            <span class="na">uri</span> <span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">uri</span>
        <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">response</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">));</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>


            <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">({</span>
                <span class="c1">// What did the server say?</span>
                <span class="na">response</span>    <span class="p">:</span> <span class="nx">response</span><span class="p">,</span>
                <span class="c1">// Did we get an error?</span>
                <span class="na">originalError</span> <span class="p">:</span> <span class="nx">error</span><span class="p">,</span>
                <span class="c1">// Was it really bad?</span>
                <span class="c1">// Do we restart the process, retry, or continue with defaults?</span>
                <span class="na">type</span>        <span class="p">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">500</span> <span class="p">?</span> <span class="s1">'fatal'</span> <span class="p">:</span> <span class="s1">'failure'</span><span class="p">,</span>
                <span class="c1">// Tell them this:</span>
                <span class="na">message</span>     <span class="p">:</span> <span class="s1">'Unable to retrieve customer data'</span>
            <span class="p">});</span>

        <span class="p">});</span>

        <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// [app/myAccount.js]</span>
<span class="nx">Customer</span>
    <span class="p">.</span><span class="nx">getData</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* 
        If you mess up, you can crash the process, 
        set defaults, or perform recovery.
        */</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">'fatal'</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Crash the process, perform error recovery.</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'FATAL_CRASH_THE_PROCESS'</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Just a failure, retry or set defaults.</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'FAILURE_SET_DEFAULTS_AND_RECOVER'</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span></code></pre></figure><p>By following the pattern above, I make sure that I only deal with successful actions, when a promise is resolved, and for the errors/exceptions part, I have that all handled in the <code class="highlighter-rouge">catch</code> callback. To make things better, we could top it off with an error handler, that is separate from our library, and that has handlers for all statuses that are of interest. An example of such a concept can be found on GitHub — see <a href="https://gist.github.com/opreaadrian/fac301833af8bcb2b8d5">this gist</a> — or if you want to give it a spin without saving on disk, on <a href="http://jsbin.com/yocese/1/edit?js,console">jsbin.com</a><h2 id="conclusions">Conclusions</h2><p>Either way you do implement error handling, it’s best to keep in mind that when you have the means to signal that there was an error, namely <code class="highlighter-rouge">reject</code> in our little <code class="highlighter-rouge">Promise</code>s world, please use that, and use meaningful information to go along with it, as it is way better to set 2 breakpoints, one for the <code class="highlighter-rouge">success</code> and one for the <code class="highlighter-rouge">error</code> callback, and then blindly click through the application until you stop on one of those breakpoints, than to obsessively stare at the debugger every 2 clicks to see if you got actual data or an error.<p>Cheers!<p><em>P.S.</em> For an alternate flow that uses a JavaScript object to hold actions for each error, based on it’s severity, you can refer to <a href="http://jsbin.com/yocese/3/edit">this bin that I put up a couple of weeks ago</a> — open it with Chrome as it uses native JavaScript promises.<blockquote><p>Image credits: <a href="https://flic.kr/p/r5cB7u">Sailors verify serial numbers on a Sidewinder practice missile.</a> by <a href="https://www.flickr.com/photos/42973403@N07/">Official U.S. Navy Page</a></blockquote></main><footer class="article-footer"><section><h3>Spread the word</h3><span class='st_facebook_large' displayText='Facebook'></span> <span class='st_twitter_large' displayText='Tweet'></span> <span class='st_linkedin_large' displayText='LinkedIn'></span> <span class='st_email_large' displayText='Email'></span> <span class='st_reddit_large' displayText='Reddit'></span> <span class='st_googleplus_large' displayText='Google +'></span> <span class='st_pinterest_large' displayText='Pinterest'></span></section><div class="pagination" role="navigation"> <a href="/working-with-javascript-promises/" title="Previous article: Working with JavaScript promises: handling the unexpected" role="prev">&larr; Working with JavaScript promises: practices and mistakes</a> <a href="/angular-services-and-factories-for-vanilla-js-developers/" title="Next article: Working with JavaScript promises: handling the unexpected" role="next">Angular services and factories for vanilla JS developers &rarr;</a></div><div id="disqus_thread"></div><script> (function() { var d = document, s = d.createElement('script'); s.src = '//codesinz.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></footer></article><script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-32468134-4', 'auto'); ga('require', 'displayfeatures'); ga('send', 'pageview'); </script> <script type="text/javascript"> var _dcq = _dcq || []; var _dcs = _dcs || {}; _dcs.account = '9282313'; (function() { var dc = document.createElement('script'); dc.type = 'text/javascript'; dc.async = true; dc.src = '//tag.getdrip.com/9282313.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(dc, s); })(); </script> <script src="/javascripts/prism.js"></script> <script type="text/javascript">var switchTo5x=true;</script> <script type="text/javascript" src="//ws.sharethis.com/button/buttons.js"></script> <script type="text/javascript">stLight.options({publisher: "92204b4b-884e-4a7f-9337-a39d86c8b368", doNotHash: true, doNotCopy: false, hashAddressBar: true, shorten: false});</script>
