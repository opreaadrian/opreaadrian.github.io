<!DOCTYPE html><html lang="en" itemscope itemtype="https://schema.org/Blog"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Working with JavaScript promises: practices and mistakes</title><meta name="keywords" content="nodejs, workflow, javascript, promises, async"><meta name="author" itemprop="creator" content="Adrian Oprea"><meta name="description" itemprop="description" content="We use promises in our day to day grind, and not few were the occasions in which I found promise-using code improperly structured, responses handled in an inconsistent manner, as well as weak or no error handling. With this post I aim to share some of my practices when it comes to working with promises. Throughout the post I will use ES6 syntax, but the principles outlined are available whether you’re using native JavaScript promises, or a library that implements the Promises A+ spec. "><meta property="og:type" content="article" /><meta property="og:title" content="Working with JavaScript promises: practices and mistakes" /><meta property="og:description" content="We use promises in our day to day grind, and not few were the occasions in which I found promise-using code improperly structured, responses handled in an inconsistent manner, as well as weak or no error handling. With this post I aim to share some of my practices when it comes to working with promises. Throughout the post I will use ES6 syntax, but the principles outlined are available whether you’re using native JavaScript promises, or a library that implements the Promises A+ spec. " /><meta property="og:image" content="https://codesi.nz/images/posts/promises.jpg" /><meta property="og:url" content="https://codesi.nz/working-with-javascript-promises/" /><meta property="og:locale" content="en_US" /><meta property="article:published_time" content="2015-01-28T08:00:00+02:00" /><meta property="article:modified_time" content="2015-01-28T22:00:00+02:00 " /><link rel="canonical" href="https://codesi.nz/working-with-javascript-promises/"><meta name="”twitter:creator”" value=""><meta name="twitter:card" content="summary_large_image"><meta name="twitter:url" content="https://codesi.nz/working-with-javascript-promises/"><meta name="twitter:title" content="Working with JavaScript promises: practices and mistakes"><meta name="twitter:description" content="We use promises in our day to day grind, and not few were the occasions in which I found promise-using code improperly structured, responses handled in an inconsistent manner, as well as weak or no error handling. With this post I aim to share some of my practices when it comes to working with promises. Throughout the post I will use ES6 syntax, but the principles outlined are available whether you’re using native JavaScript promises, or a library that implements the Promises A+ spec. "><meta name="twitter:image" content="https://codesi.nz/images/posts/promises.jpg"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="codesins. - The blog of Adrian Oprea, freelance web developer."><link rel="author" href="https://plus.google.com/+AdrianOpreasWeb/"><link rel="publisher" href="https://plus.google.com/+AdrianOpreasWeb/"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/normalize/4.0.0/normalize.min.css"><link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,300italic,700,400italic,600,600italic,700italic,800,800italic' rel='stylesheet' type='text/css'><link href='https://fonts.googleapis.com/css?family=Lato:100,300,900' rel='stylesheet' type='text/css'><link rel="stylesheet" href="/stylesheets/screen.css"> <script> var host = "codesi.nz"; if ((host == window.location.host) && (window.location.protocol != "https:")) { window.location.protocol = "https"; } </script><body><div class="header"><div role="branding" class="branding"><h1><a href="/" title="Go back to the homepage">codesins.</a></h1></div><div class="navigation"><nav role="navigation"><ul><li class="active" ><a title="Navigate to the blog" href="/">Blog</a><li ><a title="Find out more about me" href="/about/">Who am I</a><li ><a title="Go to the contact page" href="/contact/">Let's chat</a></ul></nav></div></div><article class="article-full" itemprop="blogPosts" itemscope itemtype="https://schema.org/BlogPosting"><meta itemprop="datePublished" content="2015-01-28T08:00:00+02:00"><meta itemprop="dateModified" content="2015-01-28T22:00:00+02:00"><meta itemprop="keywords" content="nodejs, workflow, javascript, promises, async"><meta itemprop="author" content="Adrian Oprea"><meta itemprop="inLanguage" content="en_US"> <span itemprop="audience" itemscope itemtype="http://schema.org/PeopleAudience"><meta itemprop="gender" content="any"> </span><header class="article-header"><h1 class="article-header__heading article-header__heading--center article-header__heading--white" itemprop="headline">Working with JavaScript promises: practices and mistakes</h1><div class="article-info article-info--delimited"><div class="article-info-inner"> <a class="article-info__author-profile" href="/about" title="About the author: Adrian Oprea"> <img class="article-info__author-image" src="/images/assets/adrian_oprea.png" alt="Author image: Adrian Oprea"> </a><p> Adrian Oprea on <time itemProp="datePublished" datetime="2015-01-28T08:00:00+02:00">28 Jan 2015</time><br> Published in <span class="categories-list"> <span class="categories-list-item">nodejs</span> </span></div></div></header><main class="article-body" itemprop="articleBody"><p>We use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">promises</a> in our day to day grind, and not few were the occasions in which I found promise-using code improperly structured, responses handled in an inconsistent manner, as well as weak or no error handling.<br /> With this post I aim to share some of my practices when it comes to working with promises. Throughout the post I will use ES6 syntax, but the principles outlined are available whether you’re using native JavaScript promises, or a library that implements the <a href="https://promisesaplus.com/">Promises A+ spec</a>.<h2 id="introduction">Introduction</h2><blockquote><p>What “is” promises?</blockquote><p>“A promise represents the eventual result of an asynchronous operation. The primary way of interacting with a promise is through its <code class="highlighter-rouge">then</code> method, which registers callbacks to receive either a promise’s eventual value or the reason why the promise cannot be fulfilled.” — <a href="https://promisesaplus.com/">Promises A+ official spec</a><p>In short, a promise object represents a wrapper around that asynchronous operation(which I sometimes call “task”), that at some point might be “resolved” or “rejected” based on whatever the completion of the operation returns. Upon resolution/rejection, the appropriate callback for the promise’s resolution state, registered by the <code class="highlighter-rouge">then</code> method, will be called with the data/rejection reason.<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// app.js</span>

<span class="c1">// Classic usage of Promises (promise w/ resolver)</span>
<span class="kd">var</span> <span class="nx">getData</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">DataService</span><span class="p">.</span><span class="nx">getCustomerDetails</span><span class="p">(</span><span class="s1">'11AFFDDDS'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">details</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">details</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="nx">details</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="cm">/* getData is a wrapper around the "task" 
   that pulls the customer details from the backend */</span>
<span class="nx">getData</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// This is the success callback</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// This is the error callback</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="p">});</span></code></pre></figure><p>Besides the previous pattern, which allows you to USE asynchronous tasks, the most common usage I find with promises is by using deferred objects, that allow you to IMPLEMENT async tasks. In this direction, we can take the example of our <code class="highlighter-rouge">getCustomerDetails</code> method from the DataService.<br /> In order to implement the method to act as a promise, we need our code to look like below:<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// dataservice.js</span>

<span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./data/dbhandler'</span><span class="p">),</span>
    <span class="nx">QUERY_FAILED</span> <span class="o">=</span> <span class="s2">"Database query failed."</span><span class="p">;</span>

<span class="c1">// [...db configuration]</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>

<span class="nx">DataService</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getCustomerDetails</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">customerID</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Create a deferred object that we'll use to control the execution flow</span>
    <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="nx">db</span><span class="p">.</span><span class="nx">getCustomer</span><span class="p">(</span><span class="nx">customerID</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">success</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// We're done, query succeeded -- doesn't mean we have data</span>
            <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="na">error</span>   <span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Something went wrong with the db. Worth investigating</span>
            <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">({</span>
                <span class="na">message</span> <span class="p">:</span> <span class="nx">QUERY_FAILED</span><span class="p">,</span>
                <span class="na">error</span>   <span class="p">:</span> <span class="nx">error</span> 
            <span class="p">})</span>
        <span class="p">}</span>  
    <span class="p">});</span>
    
    <span class="c1">// Return this so we can do DataService.getCustomerDetails().then(...)</span>
    <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><p>Now, istead of working with promises at our application level, we’re moving all the logic related to the DataService in its own, <code class="highlighter-rouge">DataService</code> module, so our application code now looks like this:<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// app.js</span>

<span class="nx">DataService</span>
    <span class="p">.</span><span class="nx">getCustomerDetails</span><span class="p">(</span><span class="s1">'11AFFDDDS'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// do something with data</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// perform proper error handling</span>
    <span class="p">});</span></code></pre></figure><h2 id="proper-naming">Proper naming</h2><blockquote><p>If you can count it, give it a noun for a name!</blockquote><p>One of the things that confuse me when I bump into code that uses promises is the naming.<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// badly named variable -- we have a DEFERRED object, not a defer action.</span>
<span class="kd">var</span> <span class="nx">defer</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

<span class="c1">// Much better</span>
<span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span></code></pre></figure><p>I’m really into clean, self-explanatory code so snippets like the one above turn my “you-re-not-respecting-the-styleguide” alarm on.<h2 id="working-with-multiple-promises">Working with multiple promises</h2><blockquote><p>Do you just <code class="highlighter-rouge">deferred.resolve(data);</code>? Then why write it 100 times?</blockquote><p>Let’s say that you use the <code class="highlighter-rouge">DataService.getCustomerDetails</code> method, along with a <code class="highlighter-rouge">Cart.getCartItems()</code> method pull in the necessary information for an order.<br /> After receiving the info, you need to set the data as properties on the <code class="highlighter-rouge">Order</code> instance. If all you’re doing is <code class="highlighter-rouge">this.property = returnedData</code>, instead of writing 2 separate calls, you can use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all"><code class="highlighter-rouge">Promise.all()</code></a>, and use its <code class="highlighter-rouge">success</code>/<code class="highlighter-rouge">rejection</code> callbacks instead of having individual callbacks for each promise.<br /> This way, if you would have to add a third promise, and set whatever data it returns on the current order, you only need to write 2 lines of code, instead of approx. 6 lines. I’m suggesting the following structure, that promotes code reuse.<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Note that this will not work currently as support for native Promises in </span>
<span class="c1">// es6-enabling module loaders/runtimes is not that stable</span>
<span class="kr">import</span> <span class="nx">DataService</span> <span class="nx">from</span> <span class="s1">'./dataservice.js'</span>
<span class="kr">import</span> <span class="nx">Cart</span> <span class="nx">from</span> <span class="s1">'./cart.js'</span>

<span class="kr">class</span> <span class="nx">Order</span> <span class="p">{</span>
    <span class="nx">constructor</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
            <span class="nx">DataService</span><span class="p">.</span><span class="nx">getCustomerDetails</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">userID</span><span class="p">),</span>
            <span class="nx">Cart</span><span class="p">.</span><span class="nx">getCartItems</span><span class="p">()</span>
        <span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">customer</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">cartData</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure><h2 id="if-error-then-reject"><code class="highlighter-rouge">IF error THEN reject</code></h2><p>Just don’t do this:<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">someAsyncTask</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="nx">ExternalService</span><span class="p">.</span><span class="nx">getData</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'An error has occurred!'</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><p>Add a case for rejection and always add use the rejection callback when using promises. Make sure you also add meaningful messaging, especially when dealing with errors/rejections.<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">someAsyncTask</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="nx">DataService</span><span class="p">.</span><span class="nx">getData</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">({</span>
                <span class="na">message</span> <span class="p">:</span> <span class="s1">'Query to the dataservice failed.'</span><span class="p">,</span>
                <span class="na">error</span>   <span class="p">:</span> <span class="nx">err</span>
            <span class="p">});</span>

            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><h2 id="dont-resolve-when-you-should-reject">Don’t <code class="highlighter-rouge">resolve</code> when you should <code class="highlighter-rouge">reject</code></h2><p>You might find yourself in a situation where you’re calling an external API, and if that call fails for some reason, you would still like to return some data from the promise, instead of rejecting it and probably making the rest of your code fail. In that situation you probably think the right thing to do is to choose a solution like the one below.<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">getOrderDetails</span><span class="p">(</span><span class="nx">orderID</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">defer</span><span class="p">(),</span>
        <span class="nx">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">orderID</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="na">items</span>   <span class="p">:</span> <span class="p">[],</span>
            <span class="na">amount</span>   <span class="p">:</span> <span class="mi">0</span>
        <span class="p">};</span>

    <span class="nx">Order</span><span class="p">.</span><span class="nx">getDetails</span><span class="p">(</span><span class="nx">orderID</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">){</span> 
        <span class="c1">// If the getDetails API endpoint fails, then just send some default data</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">error</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">500</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">defaults</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// The call looks like this</span>
<span class="nx">getOrderDetails</span><span class="p">(</span><span class="s1">'ABC123'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// do something with data</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// error handling</span>
        <span class="p">}</span>
    <span class="p">})</span></code></pre></figure><p>The problem with the code above is that only you know how to call the getOrderDetails function. If another developer has to work with your code 3 months from now, he will probably write the <code class="highlighter-rouge">getOrderDetails</code> call using both success and rejection callbacks, and will probably spend some time figuring out why somewhere along the road his order <code class="highlighter-rouge">amount</code> is set to 0. Bottom line, please use resolve/reject thoroughly, as reject doesn’t necessarily mean CRASH THE PROCESS, or BLOW UP THE APPLICATION. It’s just a way of saying that something failed and you should take an action.<h2 id="short-cirtuit--use-return">Short-cirtuit ? Use <code class="highlighter-rouge">return</code>.</h2><p>If by any chance you have to implement a method that takes a deferred as an argument and resolves/rejects it based on data resulting from further processing, you have to rely on <code class="highlighter-rouge">if-else</code> statements.<br /> In this situation, if you’re planning to short-circuit the logic, note that <code class="highlighter-rouge">deferred.resolve()</code> and <code class="highlighter-rouge">deferred.reject()</code> don’t return the control to the caller, so always use <code class="highlighter-rouge">return</code> after you resolve/reject(depends on your situation) the promise, as without it, the code will continue to run.<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">processData</span><span class="p">(</span><span class="nx">deferred</span><span class="p">,</span> <span class="nx">input</span><span class="p">)</span>
    <span class="nx">somePromiseBasedTask</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span> <span class="c1">// USE it or the logic will continue to execute below    </span>
        <span class="p">}</span>

        <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        
    <span class="p">});</span>
<span class="p">}</span></code></pre></figure><p>In the previous code block, if an error occurs and no <code class="highlighter-rouge">return</code> exists, you will be rejecting the promise as <code class="highlighter-rouge">err == true</code> and then try to resolve it, as the logic will exit the <code class="highlighter-rouge">if</code> statement and move further to the <code class="highlighter-rouge">deferred.resolve()</code> statement, which will result in an error.<h2 id="libraries">Libraries</h2><p>Last but not least, I’ll share a list of promise libraries that I really like. All of them implement the <a href="https://promisesaplus.com">Promises A+ spec</a>. For a more comprehensive list, check the conformant implementations list at <a href="https://promisesaplus.com/implementations">promisesaplus.com/implementations</a>.<ul><li><a href="https://github.com/cujojs/when">when.js</a><li><a href="https://github.com/kriskowal/q">Q</a><li><a href="https://docs.angularjs.org/api/ng/service/$q">$q</a> — the AngularJS implementation for Q</ul><p>Please make sure to leave some feedback, and submit a pull request if you find typos or errors in the logic, it was 3:00 AM when I wrote most of the content.<blockquote><p>Image credits: <a href="https://flic.kr/p/3f12JL">Promise?</a> by <a href="https://www.flickr.com/photos/13923263@N07/">Carmella Fernando</a></blockquote></main><footer class="article-footer"><section><h3>Spread the word</h3><span class='st_facebook_large' displayText='Facebook'></span> <span class='st_twitter_large' displayText='Tweet'></span> <span class='st_linkedin_large' displayText='LinkedIn'></span> <span class='st_email_large' displayText='Email'></span> <span class='st_reddit_large' displayText='Reddit'></span> <span class='st_googleplus_large' displayText='Google +'></span> <span class='st_pinterest_large' displayText='Pinterest'></span></section><div class="pagination" role="navigation"> <a href="/three-hard-to-spot-javascript-mistakes/" title="Previous article: Working with JavaScript promises: practices and mistakes" role="prev">&larr; Three hard to spot JavaScript mistakes</a> <a href="/working-with-javascript-promises-handling-the-unexpected/" title="Next article: Working with JavaScript promises: practices and mistakes" role="next">Working with JavaScript promises: handling the unexpected &rarr;</a></div><div id="disqus_thread"></div><script> (function() { var d = document, s = d.createElement('script'); s.src = '//codesinz.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></footer></article><script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-32468134-4', 'auto'); ga('require', 'displayfeatures'); ga('send', 'pageview'); </script> <script type="text/javascript"> var _dcq = _dcq || []; var _dcs = _dcs || {}; _dcs.account = '9282313'; (function() { var dc = document.createElement('script'); dc.type = 'text/javascript'; dc.async = true; dc.src = '//tag.getdrip.com/9282313.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(dc, s); })(); </script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script> <script> hljs.initHighlightingOnLoad(); </script> <script type="text/javascript">var switchTo5x=true;</script> <script type="text/javascript" src="//ws.sharethis.com/button/buttons.js"></script> <script type="text/javascript">stLight.options({publisher: "92204b4b-884e-4a7f-9337-a39d86c8b368", doNotHash: true, doNotCopy: false, hashAddressBar: true, shorten: false});</script>
