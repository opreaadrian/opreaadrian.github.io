<!DOCTYPE html><html lang="en" itemscope itemtype="https://schema.org/Blog"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Load balancing websockets with Nginx</title><meta name="keywords" content="productivity, scalability, websockets, nodejs, express, javascript, nginx, load, balancer"><meta name="author" itemprop="creator" content="Adrian Oprea"><meta name="description" itemprop="description" content="For the past year, I’ve been involved in a contract that took me through most of the areas of software development. From actual development using JavaScript, all the way to infrastructure, cloud providers, etc. I helped migrate the project from SVN to Git. After that, I managed to move the development environment to Docker, and with that experience, with the aid of the extraordinary team of people working on the project, we managed to break down the monolith into multiple applications and their respective Git repositories, and move almost all of them to Docker, in production. "><meta property="og:type" content="article" /><meta property="og:title" content="Load balancing websockets with Nginx" /><meta property="og:description" content="For the past year, I’ve been involved in a contract that took me through most of the areas of software development. From actual development using JavaScript, all the way to infrastructure, cloud providers, etc. I helped migrate the project from SVN to Git. After that, I managed to move the development environment to Docker, and with that experience, with the aid of the extraordinary team of people working on the project, we managed to break down the monolith into multiple applications and their respective Git repositories, and move almost all of them to Docker, in production. " /><meta property="og:image" content="https://codesi.nz/images/posts/load-balancing-websockets-behind-nginx/post.jpg" /><meta property="og:url" content="https://codesi.nz/load-balancing-websockets-behind-nginx/" /><meta property="og:locale" content="en_US" /><meta property="article:published_time" content="2016-08-17T19:00:00+02:00" /><meta property="article:modified_time" content="2016-08-17T19:00:00+02:00 " /><link rel="canonical" href="https://codesi.nz/load-balancing-websockets-behind-nginx/"><meta name="”twitter:creator”" value=""><meta name="twitter:card" content="summary_large_image"><meta name="twitter:url" content="https://codesi.nz/load-balancing-websockets-behind-nginx/"><meta name="twitter:title" content="Load balancing websockets with Nginx"><meta name="twitter:description" content="For the past year, I’ve been involved in a contract that took me through most of the areas of software development. From actual development using JavaScript, all the way to infrastructure, cloud providers, etc. I helped migrate the project from SVN to Git. After that, I managed to move the development environment to Docker, and with that experience, with the aid of the extraordinary team of people working on the project, we managed to break down the monolith into multiple applications and their respective Git repositories, and move almost all of them to Docker, in production. "><meta name="twitter:image" content="https://codesi.nz/images/posts/load-balancing-websockets-behind-nginx/post.jpg"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="codesins. - The blog of Adrian Oprea, freelance web developer."><link rel="author" href="https://plus.google.com/+AdrianOpreasWeb/"><link rel="publisher" href="https://plus.google.com/+AdrianOpreasWeb/"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/normalize/4.0.0/normalize.min.css"><link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,300italic,700,400italic,600,600italic,700italic,800,800italic' rel='stylesheet' type='text/css'><link href='https://fonts.googleapis.com/css?family=Lato:100,300,900' rel='stylesheet' type='text/css'><link rel="stylesheet" href="/stylesheets/screen.css"><link rel="stylesheet" href="/stylesheets/monokai.css"> <script> var host = "codesi.nz"; if ((host == window.location.host) && (window.location.protocol != "https:")) { window.location.protocol = "https"; } </script><body><div class="header"><div role="branding" class="branding"><h1><a href="/" title="Go back to the homepage">codesins.</a></h1></div><div class="navigation"><nav role="navigation"><ul><li class="active" ><a title="Navigate to the blog" href="/">Blog</a><li ><a title="Find out more about me" href="/about/">Who am I</a><li ><a title="Go to the contact page" href="/contact/">Let's chat</a></ul></nav></div></div><article class="article-full" itemprop="blogPosts" itemscope itemtype="https://schema.org/BlogPosting"><meta itemprop="datePublished" content="2016-08-17T19:00:00+02:00"><meta itemprop="dateModified" content="2016-08-17T19:00:00+02:00"><meta itemprop="keywords" content="productivity, scalability, websockets, nodejs, express, javascript, nginx, load, balancer"><meta itemprop="author" content="Adrian Oprea"><meta itemprop="inLanguage" content="en_US"> <span itemprop="audience" itemscope itemtype="http://schema.org/PeopleAudience"><meta itemprop="gender" content="any"> </span><header class="article-header"><h1 class="article-header__heading article-header__heading--center article-header__heading--white" itemprop="headline">Load balancing websockets with Nginx</h1><div class="article-info article-info--delimited"><div class="article-info-inner"> <a class="article-info__author-profile" href="/about" title="About the author: Adrian Oprea"> <img class="article-info__author-image" src="/images/assets/adrian_oprea.png" alt="Author image: Adrian Oprea"> </a><p> Adrian Oprea on <time itemProp="datePublished" datetime="2016-08-17T19:00:00+02:00">17 Aug 2016</time><br> Published in <span class="categories-list"> <span class="categories-list-item">javascript</span> </span></div></div></header><main class="article-body" itemprop="articleBody"><p>For the past year, I’ve been involved in a contract that took me through most of the areas of software development. From actual development using JavaScript, all the way to infrastructure, cloud providers, etc. I helped migrate the project from SVN to Git. After that, I managed to move the development environment to Docker, and with that experience, with the aid of the extraordinary team of people working on the project, we managed to break down the monolith into multiple applications and their respective Git repositories, and move almost all of them to Docker, in production.<h2 class="no_toc" id="table-of-contents">Table of contents</h2><ul id="markdown-toc"><li><a href="#the-challenge" id="markdown-toc-the-challenge">The challenge</a><li><a href="#the-websocket-enabled-application" id="markdown-toc-the-websocket-enabled-application">The websocket-enabled application</a><ul><li><a href="#enhancing-the-application" id="markdown-toc-enhancing-the-application">Enhancing the application</a></ul><li><a href="#using-nginxs-tcp-capabilities" id="markdown-toc-using-nginxs-tcp-capabilities">Using Nginx’s TCP capabilities</a><ul><li><a href="#what-is-nginx" id="markdown-toc-what-is-nginx">What is Nginx</a><li><a href="#why-nginx" id="markdown-toc-why-nginx">Why Nginx</a><li><a href="#the-configuration" id="markdown-toc-the-configuration">The configuration</a></ul><li><a href="#using-sticky-sessions" id="markdown-toc-using-sticky-sessions">Using sticky sessions</a><ul><li><a href="#what-are-sticky-sessions" id="markdown-toc-what-are-sticky-sessions">What are sticky sessions?</a></ul><li><a href="#using-the-new-amazon-application-load-balancer" id="markdown-toc-using-the-new-amazon-application-load-balancer">Using the new Amazon Application Load Balancer</a><ul><li><a href="#why-not-aws-elastic-load-balancerelb" id="markdown-toc-why-not-aws-elastic-load-balancerelb">Why not AWS Elastic Load Balancer(ELB)</a><li><a href="#what-is-cookie-stickyness" id="markdown-toc-what-is-cookie-stickyness">What is cookie stickyness?</a></ul><li><a href="#closing-thoughts" id="markdown-toc-closing-thoughts">Closing thoughts</a></ul><h2 id="the-challenge">The challenge</h2><p>One challenge that I recently faced, was to put multiple instances of a websocket-enabled application, behind a load balancer. I will go into the details of how I eventually overcame this issue, below.<h2 id="the-websocket-enabled-application">The websocket-enabled application</h2><p>I hate wasting time, and for the purpose of demonstration, I thought long and hard about what application should I create. I finally realised that our wonderful community already provides a wealth of free-to-use applications. I decided to use the example chat application on the official <a href="http://socket.io" title="Official website: socket.io nodejs websocket library" target="blank">socket.io</a> library.<p>Navigate to the <a href="http://socket.io/get-started/chat/" target="blank">Get started: chat application</a> page and scroll down to the bottom of the page. You will find a command that looks like this:<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>git clone https://github.com/guille/chat-example.git
</code></pre></div><p>The project is a very simple one, and this is precisely what I appreciate. First, start the project and see if it is working properly. Run <code class="highlighter-rouge">npm install</code> in the project’s directory, so all the dependencies are pulled from <a href="npmjs.org" title="Node Package Manager official site" target="blank">npmjs.org</a> and installed.<br /> Next, run <code class="highlighter-rouge">npm start</code> or <code class="highlighter-rouge">node index.js</code> and open <a href="http://localhost:3000" target="blank">http://localhost:3000</a> in your preferred browser. You should see an image similar to the one below.<p><img src="/images/posts/load-balancing-websockets-behind-nginx/chat1.png" alt="Screenshot of the default chat application" height="auto" width="50%" /><h3 id="enhancing-the-application">Enhancing the application</h3><p>In order to see which instance are we being distributed to, we need to modify the application code just a tiny bit. Here are the updates we need to make:<ul><li>Use <code class="highlighter-rouge">res.render</code> instead of <code class="highlighter-rouge">res.sendFile</code> for the chat frontend<li>Use <a href="https://www.npmjs.com/package/ejs">ejs</a> to render server-side variables in the HTML before sending it to the client<li>Set an environment variable to identify each application instance</ul><p>First, install <a href="https://www.npmjs.com/package/ejs">ejs</a> using <code class="highlighter-rouge">npm install --save ejs</code>. After installing it, we need to tell express to use <code class="highlighter-rouge">ejs</code> as a templating language.<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">// [...]</span>
<span class="kd">var</span> <span class="nx">ejs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'ejs'</span><span class="p">);</span>
<span class="c1">// [...]</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">engine</span><span class="p">(</span><span class="s1">'html'</span><span class="p">,</span> <span class="nx">ejs</span><span class="p">.</span><span class="nx">renderFile</span><span class="p">);</span>

</code></pre></div><p>If you were wondering why we’re not using Pug(ex-Jade) or some other templating module, it is because <code class="highlighter-rouge">ejs</code> is the closest to regular HTML and I wouldn’t want people reading this article to trip over templating modules/languages.<p>Back to our code, we now need to replace the <code class="highlighter-rouge">res.sendFile</code> call with <code class="highlighter-rouge">res.render</code> and also send our node identification variable with the rendered HTML.<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">// [...]</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/index.html'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">title</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_NUMBER</span> <span class="o">||</span> <span class="s1">'N/A'</span>
  <span class="p">});</span>
<span class="p">});</span>
<span class="c1">// [...]</span>
</code></pre></div><p>Your final version of <code class="highlighter-rouge">index.js</code> should look like below:<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">)();</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">).</span><span class="nx">Server</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'socket.io'</span><span class="p">)(</span><span class="nx">http</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">ejs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'ejs'</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">engine</span><span class="p">(</span><span class="s1">'html'</span><span class="p">,</span> <span class="nx">ejs</span><span class="p">.</span><span class="nx">renderFile</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/index.html'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">title</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_NUMBER</span> <span class="o">||</span> <span class="s1">'N/A'</span>
  <span class="p">});</span>
<span class="p">});</span>

<span class="nx">io</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'connection'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">){</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'chat message'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span>
    <span class="nx">io</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'chat message'</span><span class="p">,</span> <span class="nx">msg</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'listening on *:3000'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div><p>Now, you only have one thing left and you’re done with updating the chat app. You need to output the data sent from the server into the template.<br /> Modify <code class="highlighter-rouge">index.html</code> to look like below:<div class="highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Instance #<span class="cp">&lt;%=</span> <span class="n">title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;style&gt;</span>
      <span class="o">*</span> <span class="p">{</span> <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="nl">padding</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="nl">box-sizing</span><span class="p">:</span> <span class="n">border-box</span><span class="p">;</span> <span class="p">}</span>
      <span class="nt">body</span> <span class="p">{</span> <span class="nl">font</span><span class="p">:</span> <span class="m">13px</span> <span class="n">Helvetica</span><span class="p">,</span> <span class="n">Arial</span><span class="p">;</span> <span class="p">}</span>
      <span class="nt">form</span> <span class="p">{</span> <span class="nl">background</span><span class="p">:</span> <span class="m">#000</span><span class="p">;</span> <span class="nl">padding</span><span class="p">:</span> <span class="m">3px</span><span class="p">;</span> <span class="nl">position</span><span class="p">:</span> <span class="nb">fixed</span><span class="p">;</span> <span class="nl">bottom</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span> <span class="p">}</span>
      <span class="nt">form</span> <span class="nt">input</span> <span class="p">{</span> <span class="nl">border</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="nl">padding</span><span class="p">:</span> <span class="m">10px</span><span class="p">;</span> <span class="nl">width</span><span class="p">:</span> <span class="m">90%</span><span class="p">;</span> <span class="nl">margin-right</span><span class="p">:</span> <span class="m">.5%</span><span class="p">;</span> <span class="p">}</span>
      <span class="nt">form</span> <span class="nt">button</span> <span class="p">{</span> <span class="nl">width</span><span class="p">:</span> <span class="m">9%</span><span class="p">;</span> <span class="nl">background</span><span class="p">:</span> <span class="nb">rgb</span><span class="p">(</span><span class="m">130</span><span class="p">,</span> <span class="m">224</span><span class="p">,</span> <span class="m">255</span><span class="p">);</span> <span class="nl">border</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span> <span class="nl">padding</span><span class="p">:</span> <span class="m">10px</span><span class="p">;</span> <span class="p">}</span>
      <span class="nf">#messages</span> <span class="p">{</span> <span class="nl">list-style-type</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span> <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="nl">padding</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="p">}</span>
      <span class="nf">#messages</span> <span class="nt">li</span> <span class="p">{</span> <span class="nl">padding</span><span class="p">:</span> <span class="m">5px</span> <span class="m">10px</span><span class="p">;</span> <span class="p">}</span>
      <span class="nf">#messages</span> <span class="nt">li</span><span class="nd">:nth-child</span><span class="o">(</span><span class="nt">odd</span><span class="o">)</span> <span class="p">{</span> <span class="nl">background</span><span class="p">:</span> <span class="m">#eee</span><span class="p">;</span> <span class="p">}</span>
    <span class="nt">&lt;/style&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
      <span class="nt">&lt;h1&gt;</span>Instance #<span class="cp">&lt;%=</span> <span class="n">title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">"messages"</span><span class="nt">&gt;&lt;/ul&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">""</span><span class="nt">&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"m"</span> <span class="na">autocomplete=</span><span class="s">"off"</span> <span class="nt">/&gt;&lt;button&gt;</span>Send<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://cdn.socket.io/socket.io-1.2.0.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"http://code.jquery.com/jquery-1.11.1.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script&gt;</span>
      <span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">();</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'form'</span><span class="p">).</span><span class="nx">submit</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'chat message'</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#m'</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">'#m'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">});</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'chat message'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">'#messages'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'&lt;li&gt;'</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">msg</span><span class="p">));</span>
      <span class="p">});</span>
    <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div><h2 id="using-nginxs-tcp-capabilities">Using Nginx’s TCP capabilities</h2><p>First thing that came to mind was to compare Nginx with HAProxy, and make an informed choice, but I could have blindly gone with Nginx from the start and save a couple of hours of investigation.<h3 id="what-is-nginx">What is Nginx</h3><p>According to their official website, this is the “definition” of Nginx:<blockquote><p>nginx [engine x] is an HTTP and reverse proxy server, a mail proxy server, and a generic TCP/UDP proxy server, originally written by Igor Sysoev. For a long time, it has been running on many heavily loaded Russian sites including <a href="https://www.yandex.ru/" title="Yandex.ru official website" target="blank">Yandex</a>, <a href="https://mail.ru/" title="Mail.Ru official website" target="blank">Mail.Ru</a>, <a href="https://vk.com/" title="VK official website" target="blank">VK</a>, and <a href="http://www.rambler.ru/" title="Rambler.ru official website" target="blank">Rambler</a>. According to Netcraft, nginx served or proxied 27.90% busiest sites in July 2016.</blockquote><p>They also mention companies such as <a href="https://www.netflix.com" title="Netflix website" target="blank">Netflix</a>, <a href="https://wordpress.com/" title="Wordpress website" target="blank">Wordpress.com</a> and <a href="https://www.fastmail.com/" title="FastMail website" target="blank">FastMail.FM</a> in their success stories section.<br /> Bottom line, Nginx is a web server/load balancer that we can use to serve static content or to balance the load between multiple servers without affecting the customer.<h3 id="why-nginx">Why Nginx</h3><p>I remembered using Nginx for a development environment setup which required handling data distribution over Adobe Media Server’s rtmp/rtmps. That was a pretty difficult task but the rich documentation as well as the simplicity of configuring an Nginx Docker container made it all a breeze.<br /> It’s been a year since I configured that environment and it holds up pretty well. It actually worked so well for us that we used it for the whole environment, comprised of 4+ web applications each with their own domains and transports.<h3 id="the-configuration">The configuration</h3><p>Up until this point, you have a working websocket chat application with instance identification and proper rendering. Now comes the meat of the task. You need to create a Compose config file (YAML) for your application instances and for the load balancer.<br /> Let’s use the <a href="">official nginx Docker image</a> and we should do the same for NodeJS. We’ll take the <a href="">Alpine Linux version of NodeJS</a> from the Docker hub and mount our <code class="highlighter-rouge">chat-example/</code> directory inside the container.<p>Here is the full <a href="">Compose</a> configuration, with 4 application instances and a load-balancer instance, linked to the chat instances using docker links.<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2"</span>
<span class="s">services</span><span class="pi">:</span>
    <span class="s">chat1</span><span class="pi">:</span>
        <span class="s">image</span><span class="pi">:</span> <span class="s">mhart/alpine-node:4</span>
        <span class="s">hostname</span><span class="pi">:</span> <span class="s">chat1</span>
        <span class="s">environment</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">NODE_NUMBER=1</span>
        <span class="s">volumes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">./chat-example:/opt/chat"</span>
        <span class="s">working_dir</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/opt/chat"</span>
        <span class="s">command</span><span class="pi">:</span> <span class="s">npm start</span>
    <span class="s">chat2</span><span class="pi">:</span>
        <span class="s">image</span><span class="pi">:</span> <span class="s">mhart/alpine-node:4</span>
        <span class="s">hostname</span><span class="pi">:</span> <span class="s">chat2</span>
        <span class="s">environment</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">NODE_NUMBER=2</span>
        <span class="s">volumes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">./chat:/opt/chat"</span>
        <span class="s">working_dir</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/opt/chat"</span>
        <span class="s">command</span><span class="pi">:</span> <span class="s">npm start</span>
    <span class="s">chat3</span><span class="pi">:</span>
        <span class="s">image</span><span class="pi">:</span> <span class="s">mhart/alpine-node:4</span>
        <span class="s">hostname</span><span class="pi">:</span> <span class="s">chat3</span>
        <span class="s">environment</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">NODE_NUMBER=3</span>
        <span class="s">volumes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">./chat:/opt/chat"</span>
        <span class="s">working_dir</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/opt/chat"</span>
        <span class="s">command</span><span class="pi">:</span> <span class="s">npm start</span>
    <span class="s">chat4</span><span class="pi">:</span>
        <span class="s">image</span><span class="pi">:</span> <span class="s">mhart/alpine-node:4</span>
        <span class="s">hostname</span><span class="pi">:</span> <span class="s">chat4</span>
        <span class="s">environment</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">NODE_NUMBER=4</span>
        <span class="s">volumes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">./chat:/opt/chat"</span>
        <span class="s">working_dir</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/opt/chat"</span>
        <span class="s">command</span><span class="pi">:</span> <span class="s">npm start</span>
    <span class="s">load_balancer</span><span class="pi">:</span>
        <span class="s">image</span><span class="pi">:</span> <span class="s">nginx:alpine</span>
        <span class="s">volumes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">./nginx-chat.conf:/etc/nginx/nginx.conf:ro"</span>
        <span class="s">links</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">chat1:chat1"</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">chat2:chat2"</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">chat3:chat3"</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">chat4:chat4"</span>
        <span class="s">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">80:80"</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">443:443"</span>
</code></pre></div><p>As you can see, we are mounting <code class="highlighter-rouge">nginx-chat.conf</code> onto <code class="highlighter-rouge">/etc/nginx/nginx.conf</code> in the running container. Let’s take a look at <code class="highlighter-rouge">nginx-chat.conf</code> that we are going to use:<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">worker_processes</span> <span class="n">auto</span>;

<span class="n">events</span> {
    <span class="n">worker_connections</span>  <span class="m">1024</span>;
}

<span class="n">http</span> {
    <span class="n">ssl_session_cache</span>   <span class="n">shared</span>:<span class="n">SSL</span>:<span class="m">10</span><span class="n">m</span>;
    <span class="n">ssl_session_timeout</span> <span class="m">10</span><span class="n">m</span>;

    <span class="n">upstream</span> <span class="n">chat_service</span> {
      <span class="n">ip_hash</span>;
      <span class="n">server</span> <span class="n">chat1</span>:<span class="m">3000</span>;
      <span class="n">server</span> <span class="n">chat2</span>:<span class="m">3000</span>;
      <span class="n">server</span> <span class="n">chat3</span>:<span class="m">3000</span>;
      <span class="n">server</span> <span class="n">chat4</span>:<span class="m">3000</span>;
    }

    <span class="n">server</span> {
        <span class="n">listen</span>              <span class="m">80</span>;
        <span class="n">server_name</span>         <span class="n">localhost</span>;

        <span class="n">location</span> / {
            <span class="n">proxy_pass</span> <span class="n">http</span>://<span class="n">chat_service</span>;
            <span class="n">proxy_set_header</span> <span class="n">Upgrade</span> $<span class="n">http_upgrade</span>;
            <span class="n">proxy_set_header</span> <span class="n">Connection</span> <span class="s2">"upgrade"</span>;
            <span class="n">proxy_set_header</span> <span class="n">Host</span> $<span class="n">host</span>;
            <span class="n">proxy_redirect</span>   <span class="n">off</span>;
            <span class="n">proxy_http_version</span> <span class="m">1</span>.<span class="m">1</span>;
            <span class="n">proxy_set_header</span> <span class="n">X</span>-<span class="n">Real</span>-<span class="n">IP</span> $<span class="n">remote_addr</span>;
            <span class="n">proxy_set_header</span> <span class="n">X</span>-<span class="n">NginX</span>-<span class="n">Proxy</span> <span class="n">true</span>;
            <span class="n">proxy_set_header</span> <span class="n">X</span>-<span class="n">Forwarded</span>-<span class="n">Proto</span> $<span class="n">scheme</span>;
            <span class="n">proxy_set_header</span> <span class="n">X</span>-<span class="n">Forwarded</span>-<span class="n">Host</span> $<span class="n">host</span>;
            <span class="n">proxy_set_header</span> <span class="n">X</span>-<span class="n">Forwarded</span>-<span class="n">Server</span> $<span class="n">host</span>;
            <span class="n">proxy_set_header</span> <span class="n">X</span>-<span class="n">Forwarded</span>-<span class="n">For</span> $<span class="n">proxy_add_x_forwarded_for</span>;
        }
    }
}
</code></pre></div><h2 id="using-sticky-sessions">Using sticky sessions</h2><h3 id="what-are-sticky-sessions">What are sticky sessions?</h3><h2 id="using-the-new-amazon-application-load-balancer">Using the new Amazon Application Load Balancer</h2><h3 id="why-not-aws-elastic-load-balancerelb">Why not AWS Elastic Load Balancer(ELB)</h3><h3 id="what-is-cookie-stickyness">What is cookie stickyness?</h3><h2 id="closing-thoughts">Closing thoughts</h2><blockquote><p>Photo credits: <a href="http://credits.url">Credits name</a> — <a href="http://credits-image.url">Credits Image</a></blockquote></main><footer class="article-footer"><section><h3>Spread the word</h3><span class='st_facebook_large' displayText='Facebook'></span> <span class='st_twitter_large' displayText='Tweet'></span> <span class='st_linkedin_large' displayText='LinkedIn'></span> <span class='st_email_large' displayText='Email'></span> <span class='st_reddit_large' displayText='Reddit'></span> <span class='st_googleplus_large' displayText='Google +'></span> <span class='st_pinterest_large' displayText='Pinterest'></span></section><div class="pagination" role="navigation"> <a href="/event-delegation-in-tinymce-plugins/" title="Previous article: Load balancing websockets with Nginx" role="prev">&larr; Event delegation in TinyMCE plugins</a> <a href="/the-fly-theory-of-helpfulness/" title="Next article: Load balancing websockets with Nginx" role="next">The fly theory of helpfulness &rarr;</a></div><div id="disqus_thread"></div><script> (function() { var d = document, s = d.createElement('script'); s.src = '//codesinz.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></footer></article><script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-32468134-4', 'auto'); ga('require', 'displayfeatures'); ga('send', 'pageview'); </script> <script type="text/javascript"> var _dcq = _dcq || []; var _dcs = _dcs || {}; _dcs.account = '9282313'; (function() { var dc = document.createElement('script'); dc.type = 'text/javascript'; dc.async = true; dc.src = '//tag.getdrip.com/9282313.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(dc, s); })(); </script> <script type="text/javascript">var switchTo5x=true;</script> <script type="text/javascript" src="//ws.sharethis.com/button/buttons.js"></script> <script type="text/javascript">stLight.options({publisher: "92204b4b-884e-4a7f-9337-a39d86c8b368", doNotHash: true, doNotCopy: false, hashAddressBar: true, shorten: false});</script>
