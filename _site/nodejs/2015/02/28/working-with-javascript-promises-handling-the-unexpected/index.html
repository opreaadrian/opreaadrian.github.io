<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/Blog">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  
    <title>Working with JavaScript promises: handling the unexpected</title>
  

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="keywords" content="programming, blog, tutorials, technical, javascript">

  <meta name="author" itemprop="creator" content="Adrian Oprea">

  <meta property="og:locale" content="en_US" />


  
    <meta name="description" itemprop="description" content="Having worked with JavaScript Promises extensively in the past year, I often found myself in situations where handling output and errors was very hard to perform, from a semantic standpoint.
I plan on sharing my experience with promises, especially error-handling, but this is by no mean something that should be taken as a best practice, it is only my take on this issue, and you are encouraged to share your experience and practices.
">

    <meta property="og:type" content="article" />
    <meta property="og:title" content="Working with JavaScript promises: handling the unexpected" />
    <meta property="og:description" content="Having worked with JavaScript Promises extensively in the past year, I often found myself in situations where handling output and errors was very hard to perform, from a semantic standpoint.
I plan on sharing my experience with promises, especially error-handling, but this is by no mean something that should be taken as a best practice, it is only my take on this issue, and you are encouraged to share your experience and practices.
" />
    <meta property="og:image" content="http://codesi.nz/images/posts/error_handling_missile.jpg" />
    <meta property="og:url" content="http://codesi.nz/nodejs/2015/02/28/working-with-javascript-promises-handling-the-unexpected/" />
    <meta property="article:published_time" content="28 Feb 2015" />
    <meta property="article:modified_time" content="28 Feb 2015 " />
    <link rel="canonical" href="http://codesi.nz/nodejs/2015/02/28/working-with-javascript-promises-handling-the-unexpected/">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="Having worked with JavaScript Promises extensively in the past year, I often found myself in situations where handling output and errors was very hard to perform, from a semantic standpoint.
I plan on sharing my experience with promises, especially error-handling, but this is by no mean something that should be taken as a best practice, it is only my take on this issue, and you are encouraged to share your experience and practices.
">
    <meta name="twitter:url" content="http://codesi.nz/nodejs/2015/02/28/working-with-javascript-promises-handling-the-unexpected/
    ">
    <meta name="twitter:title" content="Working with JavaScript promises: handling the unexpected">
    <meta name="twitter:description" content="Having worked with JavaScript Promises extensively in the past year, I often found myself in situations where handling output and errors was very hard to perform, from a semantic standpoint.
I plan on sharing my experience with promises, especially error-handling, but this is by no mean something that should be taken as a best practice, it is only my take on this issue, and you are encouraged to share your experience and practices.
">
    <meta name="twitter:image" content="http://codesi.nz/images/posts/error_handling_missile.jpg">


  
    <meta name="”twitter:creator”" value="@opreaadrian">

  
    <link rel="author" href="https://plus.google.com/+AdrianOpreasWeb/">
    <link rel="publisher" href="https://plus.google.com/+AdrianOpreasWeb/">
  


  <!-- syntax highlighting CSS -->
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/tomorrow.min.css">

  <!-- CSS -->
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/main.css">
  <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

  <!-- Fonts -->
  <link href='http://fonts.googleapis.com/css?family=Bitter:400,700,400italic|Open+Sans:400italic,600italic,400,600|Source+Code+Pro' rel='stylesheet' type='text/css'>

</head>
<body>
  <header style="background-image: url(/images/posts/error_handling_missile.jpg);">
  <div class="container post-container">
    <a href="/" class="home_button"></a>
    <div class="inner-container">
      <h1>Working with JavaScript promises: handling the unexpected</h1>
      <ul class="meta">
        <li>
          <span>
            Author
          </span>
          <a class="post-author" href="https://twitter.com/@opreaadrian">Adrian Oprea</a>
        </li>
        <li>
          <span>
            Published
          </span>
          28 Feb 2015
        </li>
        <li>
          <span>
            Category
          </span>
          nodejs
        </li>
      </ul>
    </div>
    <ul class="pagination">
      
        <li class="previous">
          <a href="/nodejs/2015/01/28/working-with-javascript-promises/">
            Previous
          </a>
        </li>
      
      
      <li class="next">
        <a href="/angular/2015/03/08/angular-services-and-factories-for-vanilla-js-developers/">
          Next
        </a>
      </li>
      
    </ul>
  </div>
</header>

<article itemscope itemtype="http://schema.org/BlogPosting">
<meta itemprop="datePublished" content="2015-02-28T18:00:00+02:00">
<meta itemprop="dateModified" content="2015-02-28T18:00:00+02:00">
<meta itemprop="keywords" content="nodejs, workflow, javascript, promises, errors">
  <section itemprop="articleBody" class="container">
    <p>Having worked with <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">JavaScript Promises</a> extensively in the past year, I often found myself in situations where handling output and errors was very hard to perform, from a semantic standpoint.<br>
I plan on sharing my experience with promises, especially error-handling, but this is by no mean something that should be taken as a best practice, it is only my take on this issue, and you are encouraged to share your experience and practices.</p>

<h2>What&#39;s an <a href="http://en.wikipedia.org/wiki/Error">Error</a></h2>

<blockquote>
<p>The concrete meaning of the Latin word &quot;error&quot; is &quot;wandering&quot; or &quot;straying&quot;. [...] an error or a mistake can sometimes be dispelled through knowledge.</p>
</blockquote>

<p>So basically an error can be interpreted as a state that can(sometimes, of course) be resolved/repaired by applying corrective action. This is exactly how I feel about JavaScript promises and what error-handling means when working with such a concept.<br>
In my opinion, there are situations or states that involve for example killing the process, and there are other situations that only involve setting some default data if no proper response is given. These cases are to be treated in a different way, as they involve different application states.</p>

<h2>A pattern for handling the <code>unexpected</code> and the <code>uncaught</code></h2>

<p>Let&#39;s say for example that we have to implement a method that performs an async call to a REST service and returns the data to be used in the UI. The implementation    would probably look as follows:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'request'</span><span class="p">),</span>
    <span class="nx">config</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'config'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">Customer</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">getData</span> <span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

        <span class="nx">request</span><span class="p">({</span>
            <span class="na">method</span>  <span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span>
            <span class="na">uri</span> <span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">uri</span>
        <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">));</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">};</span>

</code></pre></div>
<p>You would be tempted to structure your code like the above snippet, and look for an error, and if no error is provided, then you can just resolve with the body, as nothing could have gone wrong.<br>
I say no to that approach, because you can bump into situations where you don&#39;t get an <code>Error</code> object, but you do get a <code>500 Internal Server Error</code>. </p>

<p>Even though many of the NodeJS development best practices articles, and even the NodeJS documentation itself suggests that you should have an error-first approach when working with callbacks, in situations like the one above, it&#39;s best to check for the status code and the presence of data, and forward the data to whoever is calling the method. If that&#39;s not the case, reject the promise with MEANINGFUL INFORMATION.<br>
I&#39;m stressing the &quot;meaningful information&quot; part so much because I&#39;m a firm believer in these words: &quot;Do unto others as you would have them do unto you&quot;. This doesn&#39;t mean in any way that I&#39;m a religious type of person, not that it would be a shame, but I strongly believe in the power of setting examples, so if enough people are going to be able to quickly debug and track down possible issues because I added enough error-related information, they&#39;ll soon follow that example &mdash; and I would love to see the same amout of details when I&#39;m debugging someone else&#39;s code.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// [core/customer.js]</span>
<span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'request'</span><span class="p">),</span>
    <span class="nx">config</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'config'</span><span class="p">);</span>


<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">getData</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">customerId</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

        <span class="nx">request</span><span class="p">({</span>
            <span class="na">method</span>  <span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span>
            <span class="na">uri</span> <span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">uri</span>
        <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">response</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">));</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>


            <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">({</span>
                <span class="c1">// What did the server say?</span>
                <span class="na">response</span>    <span class="p">:</span> <span class="nx">response</span><span class="p">,</span>
                <span class="c1">// Did we get an error?</span>
                <span class="na">originalError</span> <span class="p">:</span> <span class="nx">error</span><span class="p">,</span>
                <span class="c1">// Was it really bad?</span>
                <span class="c1">// Do we restart the process, retry, or continue with defaults?</span>
                <span class="na">type</span>        <span class="p">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">500</span> <span class="p">?</span> <span class="s1">'fatal'</span> <span class="p">:</span> <span class="s1">'failure'</span><span class="p">,</span>
                <span class="c1">// Tell them this:</span>
                <span class="na">message</span>     <span class="p">:</span> <span class="s1">'Unable to retrieve customer data'</span>
            <span class="p">});</span>

        <span class="p">});</span>

        <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// [app/myAccount.js]</span>
<span class="nx">Customer</span>
    <span class="p">.</span><span class="nx">getData</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* 
        If you mess up, you can crash the process, 
        set defaults, or perform recovery.
        */</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">'fatal'</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Crash the process, perform error recovery.</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'FATAL_CRASH_THE_PROCESS'</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Just a failure, retry or set defaults.</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'FAILURE_SET_DEFAULTS_AND_RECOVER'</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
</code></pre></div>
<p>By following the pattern above, I make sure that I only deal with successful actions, when a promise is resolved, and for the errors/exceptions part, I have that all handled in the <code>catch</code> callback. To make things better, we could top it off with an error handler, that is separate from our library, and that has handlers for all statuses that are of interest. An example of such a concept can be found on GitHub &mdash; see <a href="https://gist.github.com/opreaadrian/fac301833af8bcb2b8d5">this gist</a> &mdash; or if you want to give it a spin without saving on disk, on <a href="http://jsbin.com/yocese/1/edit?js,console">jsbin.com</a></p>

<h2>Conclusions</h2>

<p>Either way you do implement error handling, it&#39;s best to keep in mind that when you have the means to signal that there was an error, namely <code>reject</code> in our little <code>Promise</code>s world, please use that, and use meaningful information to go along with it, as it is way better to set 2 breakpoints, one for the <code>success</code> and one for the <code>error</code> callback, and then blindly click through the application until you stop on one of those breakpoints, than to obsessively stare at the debugger every 2 clicks to see if you got actual data or an error.</p>

<p>Cheers!</p>

<p><em>P.S.</em> For an alternate flow that uses a JavaScript object to hold actions for each error, based on it&#39;s severity, you can refer to <a href="http://jsbin.com/yocese/3/edit">this bin that I put up a couple of weeks ago</a> &mdash; open it with Chrome as it uses native JavaScript promises.</p>

<blockquote>
<p>Image credits: <a href="https://flic.kr/p/r5cB7u">Sailors verify serial numbers on a Sidewinder practice missile.</a> by <a href="https://www.flickr.com/photos/42973403@N07/">Official U.S. Navy Page</a></p>
</blockquote>


  <section>
    <h3>Share this article:</h3>
    <span class='st_facebook_large' displayText='Facebook'></span>
    <span class='st_twitter_large' displayText='Tweet'></span>
    <span class='st_linkedin_large' displayText='LinkedIn'></span>
    <span class='st_email_large' displayText='Email'></span>
    <span class='st_reddit_large' displayText='Reddit'></span>
    <span class='st_googleplus_large' displayText='Google +'></span>
    <span class='st_pinterest_large' displayText='Pinterest'></span>      
  </section>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'codesinz'; // required: replace example with your forum shortname

          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </section>
</article>




  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-32468134-4', 'auto');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');

</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
<script type="text/javascript">var switchTo5x=true;</script>
<script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
<script type="text/javascript">stLight.options({publisher: "92204b4b-884e-4a7f-9337-a39d86c8b368", doNotHash: false, doNotCopy: false, hashAddressBar: true});</script>
</body>
</html>
